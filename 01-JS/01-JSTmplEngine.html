<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>只有20行的JS模板引擎</title>
</head>

<body>
  <div id="result"> </div>
  <script>
    var TemplateEngine = function (tpl, data) {
      var re = /<%([^%>]+)?%>/g,
        // 子串是以这些有if、for等之类开头的，就不要搞push了
        reExp = /(^( )?(if|for|else|switch|case|break|{|}))(.*)?/g,
        code = 'var r=[];\n',
        cursor = 0,
        match;
      var add = function (line, js) {
        // 这种简写姿势很巧妙
        js ? code += line.match(reExp) ? `${line}\n` : `r.push(${line});\n` :
          code += `r.push("${line.replace(/"/g, '\\"')}");\n`;
      }
      while (match = re.exec(tpl)) {
        add(tpl.slice(cursor, match.index));
        add(match[1], true); //告知这里边的子串是原生JS
        cursor = match.index + match[0].length;
      }
      add(tpl.substr(cursor, tpl.length - cursor));
      code += 'return r.join("");'; // <-- return the result
      console.log(code);
      //我们搞出来的拼接而成的函数
      console.log(new Function(code.replace(/([\t\v\n\r\f])/g, '')))
      //看看eval行不：不行呀，遇到return这个关键字直接就语法错误了，说是 Illegal return statement，即非法的return语句
      // console.log(eval(code.replace(/([\t\v\n\r\f])/g, '')))
      //注意千万不要把空格也给替换了，因为我们有个var r=[]哈！不然就成了varr=[]了
      //感觉用正则做的模板引擎真得得很细心才行，不然很容易就出错了！
      console.log(new Function(code.replace(/([\t\v\n\r\f])/g, '')).apply(data))
      // 指定this为data,相较于call,apply后边的参数是数组姿势传入的！而call则是一个个传入
      return new Function(code.replace(/[\r\t\n]/g, '')).apply(data);
    }
    var template =
      'My skills:' +
      '<%for(var index in this.skills) {%>' +
      '<a href="#"><%this.skills[index]%></a>' +
      '<%}%>';
    console.log(TemplateEngine(template, {
        skills: ["js", "html", "css"]
    }));
  </script>
</body>

</html>